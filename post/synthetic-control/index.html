<!DOCTYPE html><html lang="en-us" >

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Tom Beer">

  
  
  
    
  
  <meta name="description" content="With application to California&#39;s anti-smoking program">

  
  <link rel="alternate" hreflang="en-us" href="https://tom-beer.github.io/post/synthetic-control/">

  


  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  <script src="/js/mathjax-config.js"></script>
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  




  


  
  

  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_huce93ec8a6fd7e12c2beec32639fe78a0_7050_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_huce93ec8a6fd7e12c2beec32639fe78a0_7050_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="https://tom-beer.github.io/post/synthetic-control/">

  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@aTomBeer">
  <meta property="twitter:creator" content="@aTomBeer">
  
  <meta property="og:site_name" content="Tom Beer">
  <meta property="og:url" content="https://tom-beer.github.io/post/synthetic-control/">
  <meta property="og:title" content="The Synthetic Control Method | Tom Beer">
  <meta property="og:description" content="With application to California&#39;s anti-smoking program"><meta property="og:image" content="https://tom-beer.github.io/post/synthetic-control/featured.png">
  <meta property="twitter:image" content="https://tom-beer.github.io/post/synthetic-control/featured.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-07-08T23:14:30&#43;03:00">
    
    <meta property="article:modified_time" content="2020-07-08T23:14:30&#43;03:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://tom-beer.github.io/post/synthetic-control/"
  },
  "headline": "The Synthetic Control Method",
  
  "image": [
    "https://tom-beer.github.io/post/synthetic-control/featured.png"
  ],
  
  "datePublished": "2020-07-08T23:14:30+03:00",
  "dateModified": "2020-07-08T23:14:30+03:00",
  
  "author": {
    "@type": "Person",
    "name": "Tom Beer"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Tom Beer",
    "logo": {
      "@type": "ImageObject",
      "url": "https://tom-beer.github.io/images/icon_huce93ec8a6fd7e12c2beec32639fe78a0_7050_192x192_fill_lanczos_center_2.png"
    }
  },
  "description": "With application to California's anti-smoking program"
}
</script>

  

  


  


  





  <title>The Synthetic Control Method | Tom Beer</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  







<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Tom Beer</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Tom Beer</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#publications"><span>Publications</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      

      
      <li class="nav-item dropdown theme-dropdown">
        <a href="#" class="nav-link js-theme-selector" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-palette" aria-hidden="true"></i>
        </a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item js-set-theme-light">
            <span>Light</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-dark">
            <span>Dark</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-auto">
            <span>Automatic</span>
          </a>
        </div>
      </li>
      

      

    </ul>

  </div>
</nav>


  <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>The Synthetic Control Method</h1>

  
  <p class="page-subtitle">With application to California&rsquo;s anti-smoking program</p>
  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Jul 8, 2020
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    12 min read
  </span>
  

  
  
  

  
  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style">
      <blockquote>
<p>This post was generated from a Jupyter notebook; it can be found <a href='https://github.com/tom-beer/Synthetic-Control-Examples'>here</a></p>
</blockquote>
<h3 id="motivation">Motivation</h3>
<p>Suppose we want to estimate the causal effect of:</p>
<ul>
<li>An anti smoking taxation program in California on cigarette consumption</li>
</ul>
<p>or</p>
<ul>
<li>The German reunification on West Germanyâ€™s economy</li>
</ul>
<p>or</p>
<ul>
<li>Right to carry laws on violent crimes in Texas</li>
</ul>
<p>or</p>
<ul>
<li>Uber and Lyft on traffic congestion in Paris</li>
</ul>
<p>What would be a sensible approach to answer these questions? For practitioners coming from domains like healthcare, advertisement or collaborative filtering, these questions do not seem to fit in their everyday way of thinking. The reason is that for these questions, we are interested in the effect of an intervention for a single unit, while we do not have any data about this intervention for other units.</p>
<p>Take the German reunification as an example - it is only Germany that was reunified, and the task is to infer the causal effect of that historic event. As for the other examples - sure, California was not the first to implement an anti-smoking program, and Uber is active in many cities over the globe apart from Paris. But the task considered here is to use only the intervention data for the unit in question.</p>
<hr>
<h3 id="the-qualitative-approach">The qualitative approach</h3>
<p>It seems insensible to make inferences on a single unit - what credibility could we attain? What would be the statistical properties of the estimator?</p>
<p>But for decades, qualitative analyses that seem unsensible were carried out by economists and social scientists. They would meticulously find relevant controls for the relevant treated unit, relying on informal statements of affinity between the units. Then, with a chosen control unit, identification schemes like difference-in-differences would be applied.</p>
<p>This approach has some merit - the resulting estimator is interpretable, transparent and simple. It is easy to communicate it and argue about the choice of control units. Yet it&rsquo;s clear that it is not the optimal approach, at least for practitioners of the quantitative / statistical learning schools. So the question is - can we do better? Can we devise a data-driven approach for causal effect estimation of aggregate interventions? Can we phrase a clear objective for the estimator?</p>
<hr>
<h3 id="synthetic-controls">Synthetic Controls</h3>
<p>Introduced in 2003 and formalized in 2010 by Alberto Abadie and colleagues, the synthetic control aims to bridge between the traditional qualitative approaches of the social sciences and the modern data driven approaches. It strikes a balance between the two by offering a clear objective function to optimize while constraining the model to remain transparent, interpretable and simple. It is applicable to almost any domain, and became very popular thanks to its lenient assumptions. Esteemed economists Susan Athey and Guido Imbens have called it &ldquo;arguably the most important innovation in the policy evaluation literature in the last 15 years&rdquo;. Sounds interesting? Let&rsquo;s dive in.</p>
<hr>
<h3 id="the-main-idea">The main idea</h3>
<p>The qualitative approach calls for a manual selection of control units from a pool of potential control units. The main idea of the synthetic control method is to forgo any kind of manual control selection. Instead, the method makes use of <strong>all</strong> the control units in a data-driven approach. The controls are weighted based on their similarity to the treated unit, yielding the synthetic control as a weighed combination of the original units.</p>
<details>
  <summary><b>Potential outcomes - click here for details</b></summary>
  We can formalize the main idea above in the language of potential outcomes:
<ul>
<li>For the control units, we observe the potential outcome under no-intervention</li>
<li>For the treated unit, we observe its potential outcome under no-intervention in the pre-intervention period, and its potential outcome under the intervention in the post-intervention period</li>
<li>To calculate the causal effect, we need the treated unit&rsquo;s potential outcome under no-intervention in the post-intervention period</li>
<li>The synthetic control emulates this potential outcome. It attempts to answer the question of &ldquo;What would have been the outcome for the treated unit, without the intervention?&rdquo;</li>
</ul>
</details>
<p>We see that the task of causal effect estimation boils down to finding the optimal weighting of the control units.
And how shall one find the optimal weights? This is the point where the road forks - there are many suggestions for phrasing of the optimization problem, each with its own pros and cons. The next section will describe one possibility, which is the originally proposed apparoch by Abadie et al; A discussion of its limitations in face of more contemporary approaches will follow. But first - some (minimal) notation.</p>
<hr>
<h3 id="the-setting">The setting</h3>
<ul>
<li>We have data for $T$ time periods, $T_0$ of them are pre-intervention and $T_1$ belong to the post-intervention period</li>
<li>We have $J$ control units, $j\in{1,..,n}$, and one treated unit ($j=0$)</li>
<li>The measured outcomes for each unit and time period is $Y_{jt} \in \mathbb{R}^{T \times J+1}$</li>
<li>The synthetic control is defined as $\sum_{j=1}^{J} Y_{jt} \cdot W_j$</li>
<li>The causal effect estimate is thus $\tau_t = Y_{0t} - \sum_{j=1}^{J} Y_{jt} \cdot W_j$</li>
<li>In addition, for some methods we require a set of $K$ outcome predictors for each unit: $X_{kj}\in \mathbb{R}^{K \times J+1}$. These may be lagged outcomes (pre-intervention) or other auxiliary features (or both)</li>
</ul>
<hr>
<h3 id="adhs-synthetic-control">ADH&rsquo;s synthetic control</h3>
<p>Proposed by Abadie, Diamond and Hainmueller (hence the name) in 
<a href="https://www.tandfonline.com/doi/abs/10.1198/jasa.2009.ap08746" target="_blank" rel="noopener">this paper</a>, this is the seminal proposal for policy evaluation using synthetic controls. Apart from introducing the main idea above, they present the following objective function:</p>
<p>$$W^* \in argmin_{W \in {\Delta}^{J}} \lVert \mathbf{X_0-X_{\neg0} \cdot W} \rVert  $$</p>
<p>Some remarks:</p>
<ul>
<li>
<p>The similarity between the controls and the treated units is measured with respect to the features $X$, while the synthetic control is constructed using the outcomes $Y$. It might seem more sensible to perform the matching with respect the outcome from the start. After all, we are interested in a good pre-treatment fit for the outcome, and the best fit would be obtained using the outcome and not a proxy for it. Indeed, recent works claim that &ldquo;<em>covariates are of less relevance in applications; outcomes tend to be substantially more important than covariates in terms of predictive power</em>&rdquo; (
<a href="https://arxiv.org/abs/1607.00699" target="_blank" rel="noopener">see here</a>)</p>
</li>
<li>
<p>The weights are constrained to lie in the J-simplex, i.e. they should be non-negative and sum to one. The authors impose this constraint to avoid extrapolation and increase the method&rsquo;s transparency. But like the previous point, here too recent studies recommend to remove this constraint, stating that it is not obvious that restricting the weights this way is optimal (
<a href="https://arxiv.org/abs/1607.00699" target="_blank" rel="noopener">see here</a>). From a different angle, this constraint could be seen as weight regularization, for example 
<a href="https://arxiv.org/pdf/1803.00096.pdf" target="_blank" rel="noopener">this work</a> shows an equivalence between the simplex constraint and LASSO regularization with a fixed coefficient. The question that arises is - why use a fixed-strength regularization, instead of using LASSO with cross-validation?</p>
</li>
</ul>
<p>These are valid and thoughtful concerns. I think it would be best to take the main idea of the synthetic control method, but to experiment with the implementation details for each use case.</p>
<hr>
<h2 id="an-example-use-case">An example use case</h2>
<h3 id="estimating-the-effect-of-californias-tobacco-control-program">Estimating the effect of Californiaâ€™s tobacco control program</h3>
<p>This section will demonstrate the described method on a specific use case. The case of California&rsquo;s tobacco control program was one of the first applications of the synthetic control method, and it was introduced in 
<a href="https://www.tandfonline.com/doi/abs/10.1198/jasa.2009.ap08746" target="_blank" rel="noopener">this paper</a>. I will recover all steps: data processing, feature extraction, synthetic control construction and causal effect estimation - exactly as shown in the paper and described above (no modifications at all to the original method). If something wasn&rsquo;t clear above - hopefully this example will clarify things up.</p>
<h5 id="the-research-question">The research question</h5>
<p>In 1988 California implemented a large scale tobacco control program, called proposition 99, that increased  Californiaâ€™s cigarette excise tax by 25 cents per pack, earmarked the tax revenues to health and anti-smoking education budgets, funded anti-smoking media campaigns, and spurred local clean indoor-air ordinances throughout the state. The question we are interested here it to evaluate the policy&rsquo;s effect in terms of per-capita cigarette consumption. The potential controls in this case are all US states (that&rsquo;s an 
<a href="https://en.wikipedia.org/wiki/RAS_syndrome" target="_blank" rel="noopener">RAS</a>).</p>
<h5 id="data">Data</h5>
<ul>
<li>The main outcome is annual per-capita cigarette consumption. The data for this can be found 
<a href="https://github.com/johnson-shuffle/mixtape/tree/master/data" target="_blank" rel="noopener">here</a>.</li>
<li>In addition to the main outcome, we will utilize some features that correlate with it (GDP, ages, beer consumption etc). This data is taken from 
<a href="https://github.com/jehangiramjad/tslib/tree/master/tests/testdata" target="_blank" rel="noopener">here</a>.</li>
</ul>
<pre><code class="language-python">df_outcome_raw = pd.read_csv('prop99.csv')
df_outcome_raw = df_outcome_raw[df_outcome_raw['SubMeasureDesc'] == 'Cigarette Consumption (Pack Sales Per Capita)']
df_outcome = pd.DataFrame(df_outcome_raw.pivot_table(values='Data_Value', index='LocationDesc', columns=['Year']).to_records())

rda_predictors = pyreadr.read_r('smoking.rda')
df_predictors = pd.DataFrame(list(rda_predictors.values())[0])
print(f'The original dataset contains {df_outcome.LocationDesc.unique().shape[0]} states')
</code></pre>
<pre><code>The original dataset contains 51 states
</code></pre>
<p>As part of the method&rsquo;s assumptions and requirements, it is important to exclude from the donor pool (this is how the collection of control units is traditionally called) any unit that may not be a true control - i.e. any unit that has implemented a similar intervention. In our case, some states also introduced anti-smoking programs or substantially increased the tax for cigarettes:</p>
<pre><code class="language-python">bad_states = ['Massachusetts', 'Arizona', 'Oregon', 'Florida', 'Alaska', 'Hawaii', 'Maryland', 
              'Michigan', 'New Jersey', 'New York', 'Washington', 'District of Columbia']

df_outcome.drop(df_outcome[df_outcome['LocationDesc'].isin(bad_states)].index, inplace=True)
ca_id = df_outcome[df_outcome['LocationDesc'] == 'California'].index.item()
df_outcome = df_outcome.reset_index()
df_outcome = df_outcome.rename(columns={'index': 'org_index'})
print(f'After filtering out some states, we are left with {df_outcome.LocationDesc.unique().shape[0]} states (including California):')
df_outcome.head()
</code></pre>
<pre><code>After filtering out some states, we are left with 39 states (including California):
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>org_index</th>
      <th>LocationDesc</th>
      <th>1970</th>
      <th>1971</th>
      <th>1972</th>
      <th>1973</th>
      <th>1974</th>
      <th>1975</th>
      <th>1976</th>
      <th>1977</th>
      <th>...</th>
      <th>2005</th>
      <th>2006</th>
      <th>2007</th>
      <th>2008</th>
      <th>2009</th>
      <th>2010</th>
      <th>2011</th>
      <th>2012</th>
      <th>2013</th>
      <th>2014</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>Alabama</td>
      <td>89.8</td>
      <td>95.4</td>
      <td>101.1</td>
      <td>102.9</td>
      <td>108.2</td>
      <td>111.7</td>
      <td>116.2</td>
      <td>117.1</td>
      <td>...</td>
      <td>82.4</td>
      <td>83.3</td>
      <td>80.2</td>
      <td>78.0</td>
      <td>75.6</td>
      <td>71.5</td>
      <td>68.4</td>
      <td>67.2</td>
      <td>64.6</td>
      <td>61.7</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>Arkansas</td>
      <td>100.3</td>
      <td>104.1</td>
      <td>103.9</td>
      <td>108.0</td>
      <td>109.7</td>
      <td>114.8</td>
      <td>119.1</td>
      <td>122.6</td>
      <td>...</td>
      <td>82.1</td>
      <td>81.4</td>
      <td>78.4</td>
      <td>77.0</td>
      <td>72.6</td>
      <td>63.2</td>
      <td>61.1</td>
      <td>60.5</td>
      <td>57.5</td>
      <td>54.4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4</td>
      <td>California</td>
      <td>123.0</td>
      <td>121.0</td>
      <td>123.5</td>
      <td>124.4</td>
      <td>126.7</td>
      <td>127.1</td>
      <td>128.0</td>
      <td>126.4</td>
      <td>...</td>
      <td>33.1</td>
      <td>32.9</td>
      <td>31.8</td>
      <td>30.3</td>
      <td>28.8</td>
      <td>26.3</td>
      <td>26.0</td>
      <td>25.2</td>
      <td>23.9</td>
      <td>22.7</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5</td>
      <td>Colorado</td>
      <td>124.8</td>
      <td>125.5</td>
      <td>134.3</td>
      <td>137.9</td>
      <td>132.8</td>
      <td>131.0</td>
      <td>134.2</td>
      <td>132.0</td>
      <td>...</td>
      <td>57.9</td>
      <td>53.1</td>
      <td>51.1</td>
      <td>48.4</td>
      <td>46.0</td>
      <td>41.4</td>
      <td>40.6</td>
      <td>40.6</td>
      <td>38.3</td>
      <td>36.7</td>
    </tr>
    <tr>
      <th>4</th>
      <td>6</td>
      <td>Connecticut</td>
      <td>120.0</td>
      <td>117.6</td>
      <td>110.8</td>
      <td>109.3</td>
      <td>112.4</td>
      <td>110.2</td>
      <td>113.4</td>
      <td>117.3</td>
      <td>...</td>
      <td>49.9</td>
      <td>50.9</td>
      <td>50.5</td>
      <td>47.4</td>
      <td>45.9</td>
      <td>40.8</td>
      <td>36.3</td>
      <td>33.5</td>
      <td>31.4</td>
      <td>30.1</td>
    </tr>
  </tbody>
</table>
<p>5 rows Ã— 47 columns</p>
</div>
<p>Let&rsquo;s construct the matrices defined above:</p>
<pre><code class="language-python">df_outcome_ca = df_outcome.loc[df_outcome['LocationDesc'] == 'California', :]
df_outcome_control = df_outcome.loc[df_outcome['LocationDesc'] != 'California', :]

ca_outcomes_pre = df_outcome_ca.loc[:,[str(i) for i in list(range(START_TIME, INTERVENTION_TIME))]].values.reshape(-1,1)
control_outcomes_pre = df_outcome_control.loc[:,[str(i) for i in list(range(START_TIME, INTERVENTION_TIME))]].values.transpose()

ca_outcomes_post = df_outcome_ca.loc[:,[str(i) for i in list(range(INTERVENTION_TIME, STOP_TIME))]].values.reshape(-1,1)
control_outcomes_post = df_outcome_control.loc[:,[str(i) for i in list(range(INTERVENTION_TIME, STOP_TIME))]].values.transpose()
</code></pre>
<p>If we plot the outcomes for California vs. an average of all US states, we see that the &lsquo;average control state&rsquo; is not like California in the pre-intervention period, violating the parallel trends assumption required to draw inferences. Therefore we will find an optimal weighting that would attain a good fit to California in the pre-intervention period.</p>
<pre><code class="language-python">mean_outcomes = np.vstack([control_outcomes_pre, control_outcomes_post]).mean(axis=1)
CA_outcomes = np.vstack([ca_outcomes_pre, ca_outcomes_post]).flatten()
fig = plt.figure(figsize=(7.5,4.5))
plt.plot(range(START_TIME,STOP_TIME),mean_outcomes, 'r--', label=&quot;rest of the U.S.&quot;);
plt.plot(range(START_TIME,STOP_TIME),CA_outcomes, 'b-', label=&quot;California&quot;);

plt.ylabel('per-capita cigarette sales (in packs)')
plt.xlabel('year')
plt.legend(loc='upper right')
plt.title(&quot;Figure 1: Trends in per-capita cigarette sales: California vs. the rest of the United States&quot;)
plt.axvline(INTERVENTION_TIME)
plt.text(x=INTERVENTION_TIME+0.2, y=30, s='Passage of Proposition 99')
plt.xlim([START_TIME, STOP_TIME-1])
plt.ylim([0, 150])
plt.grid()
plt.show()
</code></pre>
<p><img src="/intro_files/output_8_0.png" alt="png"></p>
<p>Now let&rsquo;s extract the covariates used in the paper.</p>
<blockquote>
<p>Note that some of the boilerplate code has been rendered out of the html file, but it can be found in the original notebook 
<a href="">here</a></p>
</blockquote>
<pre><code class="language-python">control_predictors = []
for state in df_outcome['LocationDesc'].unique():
    state_predictor_vec = extract_predictor_vec(state)
    if state == 'California':
        ca_predictors = state_predictor_vec
    else:
        control_predictors += [state_predictor_vec]

control_predictors = np.hstack(control_predictors)
</code></pre>
<h4 id="construction-of-synthetic-control">Construction of synthetic control</h4>
<p>And here is how we optimize the objective function.</p>
<p>Note that in the original paper, the authors suggested to add feature importance weights $V$ to be tuned simultaneously with the control weights $W$. I am not convinced that these are required, especially if all features are scaled properly. But in order to reproduce the same results as in the paper, these importance weights are tuned here too. Without them, the optimization would have been a single line of least squares..</p>
<pre><code class="language-python">def w_mse(w, v, x0, x1): return mean_squared_error(x1, x0.dot(w), sample_weight=v)

def w_constraint(w, v, x0, x1): return np.sum(w) - 1

def v_constraint(V, W, X0, X1, Z0, Z1): return np.sum(V) - 1

def fun_w(w, v, x0, x1): return fmin_slsqp(w_mse, w, bounds=[(0.0, 1.0)]*len(w), f_eqcons=w_constraint, 
                                           args=(v, x0, x1), disp=False, full_output=True)[0]

def fun_v(v, w, x0, x1, z0, z1): return mean_squared_error(z1, z0.dot(fun_w(w, v, x0, x1)))

def solve_synthetic_control(X0, X1, Z0, Z1, Y0):
    k,j = X0.shape
    V0 = 1/k*np.ones(k)
    W0 = 1/j*np.zeros(j).transpose()
    V = fmin_slsqp(fun_v, V0, args=(W0, X0, X1, Z0, Z1), bounds=[(0.0, 1.0)]*len(V0), disp=True, f_eqcons=v_constraint, acc=1e-6)
    W = fun_w(W0, V, X0, X1)
    return V, W

V, W = solve_synthetic_control(control_predictors, ca_predictors, control_outcomes_pre, ca_outcomes_pre, control_outcomes_post)
</code></pre>
<pre><code>Optimization terminated successfully    (Exit mode 0)
            Current function value: 23.45850495358178
            Iterations: 5
            Function evaluations: 8
            Gradient evaluations: 1
</code></pre>
<p>The optimization terminated successfully, but we need to examine the obtained fit with respect to the features. The values for the &lsquo;average state&rsquo; are shown for reference.</p>
<pre><code class="language-python">mean_predictors = X0.mean(axis=1)
print(&quot;Table 1: Cigarette sales predictor means \n&quot;)
display(pd.DataFrame(np.hstack([X1, X0.dot(W).reshape(-1,1), mean_predictors.reshape(-1,1)]), 
             columns=['Real California', 'Synthetic California', 'Average of 38 Controls']))
</code></pre>
<pre><code>Table 1: Cigarette sales predictor means 
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Real California</th>
      <th>Synthetic California</th>
      <th>Average of 38 Controls</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10.076559</td>
      <td>10.076559</td>
      <td>10.076559</td>
    </tr>
    <tr>
      <th>1</th>
      <td>17.353238</td>
      <td>17.353238</td>
      <td>17.353238</td>
    </tr>
    <tr>
      <th>2</th>
      <td>89.422223</td>
      <td>89.422223</td>
      <td>89.422223</td>
    </tr>
    <tr>
      <th>3</th>
      <td>24.280000</td>
      <td>24.280000</td>
      <td>24.280000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>90.100000</td>
      <td>90.099950</td>
      <td>113.823684</td>
    </tr>
    <tr>
      <th>5</th>
      <td>120.200000</td>
      <td>120.200020</td>
      <td>138.089474</td>
    </tr>
    <tr>
      <th>6</th>
      <td>127.100000</td>
      <td>127.100214</td>
      <td>136.931579</td>
    </tr>
  </tbody>
</table>
</div>
<p>Seems perfect.</p>
<p>We can inspect which of the states contributed most to the synthetic control construction. These states are interpreted to be similar to California. And because of the simplex constraint, the solution is sparse - there are just a few states with non-negative weights.</p>
<pre><code class="language-python">largest_weights = list(df_outcome['LocationDesc'].values[1+np.flip(W.argsort())][:5])
print(', '.join(largest_weights))

</code></pre>
<pre><code>Utah, North Carolina, North Dakota, Montana, New Hampshire
</code></pre>
<p>Now Let&rsquo;s construct and examine the obtained synthetic control:</p>
<pre><code class="language-python">SC_outcomes = np.vstack([Z0, Y0]).dot(W)
CA_outcomes = np.vstack([Z1, Y1]).flatten()
fig = plt.figure(figsize=(7.5,4.5)) 

plt.plot(range(START_TIME,STOP_TIME),SC_outcomes, 'r--', label=&quot;Synthetic California&quot;);
plt.plot(range(START_TIME,STOP_TIME),CA_outcomes, 'b-', label=&quot;California&quot;);

plt.ylabel('per-capita cigarette sales (in packs)')
plt.xlabel('year')
plt.legend(loc='upper right')
plt.title(&quot;Figure 2: Trends in per-capita cigarette sales: California vs. synthetic California&quot;)
plt.axvline(INTERVENTION_TIME)
plt.text(x=INTERVENTION_TIME+0.2, y=30, s='Passage of Proposition 99')
plt.xlim([START_TIME, STOP_TIME-1])
plt.ylim([0, 140])
plt.grid()
plt.show()
</code></pre>
<p><img src="/intro_files/output_18_0.png" alt="png"></p>
<p>The pre-intervention fit is reasonable, so we can move on with confidence to calculate the causal effect. This is as simple as subtracting the two lines:</p>
<pre><code class="language-python">Gap_outcome = np.vstack([Z0, Y0]).dot(W) - np.vstack([Z1, Y1]).flatten()
fig = plt.figure(figsize=(7.5,4.5)) 

plt.plot(range(START_TIME,STOP_TIME),Gap_outcome, 'r--');
plt.ylabel('gap in per-capita cigarette sales (in packs)')
plt.xlabel('year')
plt.title(&quot;Figure 3: Per-capita cigarette sales gap between California and synthetic California&quot;)
plt.axhline(0)
plt.axvline(INTERVENTION_TIME)
plt.text(x=INTERVENTION_TIME-9.5, y=30, s='Passage of Proposition 99')
plt.xlim([START_TIME, STOP_TIME-1])
plt.ylim([35, -35])
plt.grid()
plt.show()
</code></pre>
<p><img src="/intro_files/output_20_0.png" alt="png"></p>
<p>With this plot, we can carefully conclude that the implementation of proposition 99 has caused a per-capita reduction of around 26 packs of cigarettes each year. Not bad!</p>
<h4 id="summary">Summary</h4>
<p>This post introduced the synthetic control method for policy evaluation and demonstrated its use on a famous example. I think this is a very interesting and fun topic that does not receive the attention it deserves. It is widely applicable and requires minimal and reasonable assumptions. The next post will go through another example that has not been addressed yet - what is the effect of Haifa&rsquo;s newly introduced low emission zone (LEZ)? Stay tuned!</p>

    </div>

    



















  
  





  
    
    
    
      
    
    
    
    <div class="media author-card content-widget-hr">
      
        
        <img class="avatar mr-3 avatar-circle" src="/author/tom-beer/avatar_hu9034ec2da80e6325848318956e058d92_564834_270x270_fill_q90_lanczos_center.jpg" alt="Tom Beer">
      

      <div class="media-body">
        <h5 class="card-title"><a href="https://tom-beer.github.io/">Tom Beer</a></h5>
        
        
        <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
    <li>
      <a href="mailto:tom1beer@gmail.com" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/aTomBeer" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/tom-beer/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/tom-beer" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://scholar.google.com/citations?user=6wZ70dEAAAAJ&amp;hl=en" target="_blank" rel="noopener">
        <i class="ai ai-google-scholar"></i>
      </a>
    </li>
  
</ul>

      </div>
    </div>
  
















  </div>
</article>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    

    
    

    

    
    

    
    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
    
    
    <script src="/js/academic.min.6f7ce8be710290b8c431bbc97f405d15.js"></script>

    






  
  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    
  </p>

  
  






  <p class="powered-by">
    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
